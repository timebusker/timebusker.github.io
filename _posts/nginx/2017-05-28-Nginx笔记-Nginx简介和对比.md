---
layout:     post
title:      三大主流软件负载均衡器对比
date:       2017-05-28
author:     timebusker
header-img: img/home-bg.jpg
header-img: img/taylorswift/post-bg-swift.jpg
catalog: true
tags:
    - Nginx
---

### Nginx简介  
- Nginx("engine x")是一个高性能的`HTTP`和`反向代理`服务器，也是一个`IMAP/POP3/SMTP`代理服务器。因其稳定性、丰富的功能集、示例配置文件和低系统资源的消耗而闻名。

- Nginx特点  

  **反向代理**([所谓代理就是一个代表、一个渠道](#))  
  
  **关于代理:**  
  涉及到两个角色，一个是被代理角色，一个是目标角色，被代理角色通过这个代理访问目标角色完成一些任务的过程称为代理操作过程；
  如同生活中的专卖店~客人到adidas专卖店买了一双鞋，这个专卖店就是代理，被代理角色就是adidas厂家，目标角色就是用户。
  ![image](https://raw.githubusercontent.com/timebusker/timebusker.github.io/master/img/20180320-1/1.png?raw=true)  
  
  **正向代理**  
  说反向代理之前，我们先看看正向代理，正向代理也是大家最常接触的到的代理模式，我们会从两个方面来说关于正向代理的处理模式，分别从软件方面和生活方面来解释一下什么叫正向代理。   
  
  在如今的网络环境下，我们如果由于技术需要要去访问国外的某些网站，此时你会发现位于国外的某网站我们通过浏览器是没有办法访问的，此时大家可能都会用一个操作FQ进行访问，FQ的方式主要是找到一个可以访问国外网站的代理服务器，我们将请求发送给代理服务器，代理服务器去访问国外的网站，然后将访问到的数据传递给我们！  
  
  上述这样的代理模式称为正向代理，正向代理最大的特点是客户端非常明确要访问的服务器地址；服务器只清楚请求来自哪个代理服务器，而不清楚来自哪个具体的客户端；正向代理模式屏蔽或者隐藏了真实客户端信息。  
  ![image](https://raw.githubusercontent.com/timebusker/timebusker.github.io/master/img/20180320-1/2.png?raw=true)  
  
  **反向代理**  
  明白了什么是正向代理，我们继续看关于反向代理的处理方式，举例如我大天朝的某宝网站，每天同时连接到网站的访问人数已经爆表，单个服务器远远不能满足人民日益增长的购买欲望了，此时就出现了一个大家耳熟能详的名词：分布式部署；也就是通过部署多台服务器来解决访问人数限制的问题；某宝网站中大部分功能也是直接使用nginx进行反向代理实现的，并且通过封装nginx和其他的组件之后起了个高大上的名字：Tengine，有兴趣的童鞋可以访问Tengine的官网查看具体的信息：http://tengine.taobao.org/。那么反向代理具体是通过什么样的方式实现的分布式的集群操作呢，我们先看一个示意图：
  ![image](https://raw.githubusercontent.com/timebusker/timebusker.github.io/master/img/20180320-1/3.png?raw=true)   
  通过上述的图解大家就可以看清楚了，多个客户端给服务器发送的请求，nginx服务器接收到之后，按照一定的规则分发给了后端的业务处理服务器进行处理了。此时~请求的来源也就是客户端是明确的，但是请求具体由哪台服务器处理的并不明确了，nginx扮演的就是一个反向代理角色。  
  [**反向代理，主要用于服务器集群分布式部署的情况下，反向代理隐藏了服务器的信息！**](#)
  
  **项目场景**  
  通常情况下，我们在实际项目操作时，正向代理和反向代理很有可能会存在在一个应用场景中，正向代理代理客户端的请求去访问目标服务器，目标服务器是一个反向单利服务器，反向代理了多台真实的业务处理服务器。具体的拓扑图如下：
  ![image](https://raw.githubusercontent.com/timebusker/timebusker.github.io/master/img/20180320-1/4.png?raw=true)    
  
  **负载均衡**  
  请求数量按照一定的规则进行分发到不同的服务器处理的规则，就是一种均衡规则,将服务器接收到的请求按照规则分发的过程，称为负载均衡。  
  负载均衡在实际项目操作过程中，有硬件负载均衡和软件负载均衡两种，硬件负载均衡也称为硬负载，如F5负载均衡，相对造价昂贵成本较高，但是数据的稳定性安全性等等有非常好的保障，如中国移动中国联通这样的公司才会选择硬负载进行操作；更多的公司考虑到成本原因，会选择使用软件负载均衡，软件负载均衡是利用现有的技术结合主机硬件实现的一种消息队列分发机制。
  ![image](https://raw.githubusercontent.com/timebusker/timebusker.github.io/master/img/20180320-1/5.png?raw=true)   
  
  **nginx支持的负载均衡调度算法方式如下：**
  - **weight轮询（默认）**：接收到的请求按照顺序逐一分配到不同的后端服务器，即使在使用过程中，某一台后端服务器宕机，nginx会自动将该服务器剔除出队列，请求受理情况不会受到任何影响。 这种方式下，可以给不同的后端服务器设置一个权重值（weight），用于调整不同的服务器上请求的分配率；权重数据越大，被分配到请求的几率越大；该权重值，主要是针对实际工作环境中不同的后端服务器硬件配置进行调整的。
  - **ip_hash**：每个请求按照发起客户端的ip的hash结果进行匹配，这样的算法下一个固定ip地址的客户端总会访问到同一个后端服务器，这也在一定程度上解决了集群部署环境下session共享的问题。  
  - **fair**：智能调整调度算法，动态的根据后端服务器的请求处理到响应的时间进行均衡分配，响应时间短处理效率高的服务器分配到请求的概率高，响应时间长处理效率低的服务器分配到的请求少；结合了前两者的优点的一种调度算法。但是需要注意的是nginx默认不支持fair算法，如果要使用这种调度算法，请安装upstream_fair模块。 
  - **url_hash**：按照访问的url的hash结果分配请求，每个请求的url会指向后端固定的某个服务器，可以在nginx作为静态服务器的情况下提高缓存效率。同样要注意nginx默认不支持这种调度算法，要使用的话需要安装nginx的hash软件包。

### 三大主流软件负载均衡器对比(LVS 、 Nginx 、Haproxy)

##### LVS(Linux Virtual Server)
   1、抗负载能力强。抗负载能力强、性能高，能达到F5硬件的60%；对内存和cpu资源消耗比较低。
   2、工作在网络4层，通过vrrp协议转发（仅作分发之用），具体的流量由linux内核处理，因此没有流量的产生。
   2、稳定性、可靠性好，自身有完美的热备方案；（如：LVS+Keepalived）
   3、应用范围比较广，可以对所有应用做负载均衡；
   4、不支持正则处理，不能做动静分离。
   5、支持负载均衡算法：rr（轮循）、wrr（带权轮循）、lc（最小连接）、wlc（权重最小连接）
   6、配置复杂，对网络依赖比较大，稳定性很高。

##### Ngnix 
   1、工作在网络的7层之上，可以针对http应用做一些分流的策略，比如针对域名、目录结构；
   2、Nginx对网络的依赖比较小，理论上能ping通就就能进行负载功能；
   3、Nginx安装和配置比较简单，测试起来比较方便；
   4、也可以承担高的负载压力且稳定，一般能支撑超过1万次的并发；
   5、对后端服务器的健康检查，只支持通过端口来检测，不支持通过url来检测。
   6、Nginx对请求的异步处理可以帮助节点服务器减轻负载；
   7、Nginx仅能支持http、https和Email协议，这样就在适用范围较小。
   8、不支持Session的直接保持，但能通过ip_hash来解决。对Big request header的支持不是很好，
   9、支持负载均衡算法：Round-robin（轮循）、Weight-round-robin（带权轮循）、Ip-hash（Ip哈希）
   10、Nginx还能做Web服务器即Cache功能。

##### HAProxy  
   1、支持两种代理模式：TCP（四层）和HTTP（七层），支持虚拟主机；
   2、能够补充Nginx的一些缺点比如Session的保持，Cookie的引导等工作
   3、支持url检测后端的服务器出问题的检测会有很好的帮助。
   4、更多的负载均衡策略比如：动态加权轮循(Dynamic Round Robin)，加权源地址哈希(Weighted Source Hash)，加权URL哈希和加权参数哈希(Weighted Parameter Hash)已经实现
   5、单纯从效率上来讲HAProxy更会比Nginx有更出色的负载均衡速度。
   6、HAProxy可以对Mysql进行负载均衡，对后端的DB节点进行检测和负载均衡。
   9、支持负载均衡算法：Round-robin（轮循）、Weight-round-robin（带权轮循）、source（原地址保持）、RI（请求URL）、rdp-cookie（根据cookie）
   10、不能做Web服务器即Cache。
   11，自带强大的监控页面。
   
##### 总结
   1、网站建设初期，可以选用Nigix/HAproxy作为反向代理负载均衡（或者流量不大都可以不选用负载均衡），因为其配置简单，性能也能满足一般的业务场景。如果考虑到负载均衡器是有单点问题，可以采用Nginx+Keepalived/HAproxy+Keepalived避免负载均衡器自身的单点问题。
   2、网站并发达到一定程度之后，为了提高稳定性和转发效率，可以使用LVS、毕竟LVS比Nginx/HAproxy要更稳定，转发效率也更高。不过维护LVS对维护人员的要求也会更高，投入成本也更大。注：Niginx与Haproxy比较：Niginx支持七层、用户量最大，稳定性比较可靠。Haproxy支持四层和七层，支持更多的负载均衡算法，支持session保存等。具体选型看使用场景，目前来说Haproxy由于弥补了一些Niginx的缺点用户量也不断在提升。